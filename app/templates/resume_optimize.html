{% extends "base.html" %}

{% block title %}{{ page_title }} - MyResumo{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto py-6 px-4 sm:px-6 lg:px-8" 
     x-data="resumeOptimizer()" 
     x-init="init('{{ resume_id }}')">
    <h1 class="text-3xl font-bold text-gray-900 mb-4">Optimize Your Resume</h1>
    <p class="text-gray-600 mb-8">Enhance your resume's ATS compatibility score with AI-powered optimization</p>
    
    <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
        <!-- Resume Details Section -->
        <div class="mb-8" x-show="resumeDetails">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Resume Details</h2>
                <div x-show="resumeDetails.ats_score !== undefined && resumeDetails.ats_score !== null" 
                     class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium"
                     :class="{
                        'bg-green-100 text-green-800': resumeDetails.ats_score >= 80,
                        'bg-yellow-100 text-yellow-800': resumeDetails.ats_score >= 60 && resumeDetails.ats_score < 80,
                        'bg-red-100 text-red-800': resumeDetails.ats_score < 60
                     }">
                    <span x-text="resumeDetails.ats_score + '%'"></span>
                    <span class="ml-1">ATS Score</span>
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex flex-col md:flex-row md:items-start gap-6">
                    <div class="flex-1">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Resume Title</h3>
                        <p class="text-gray-900 font-semibold" x-text="resumeDetails.title || 'Untitled Resume'"></p>
                        
                        <h3 class="text-sm font-medium text-gray-700 mt-4 mb-2">Last Updated</h3>
                        <p class="text-gray-900" x-text="formatDate(resumeDetails.updated_at) || 'Not available'"></p>
                    </div>
                    
                    <div class="flex-1">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Resume Preview</h3>
                        <div class="bg-white border border-gray-200 rounded-md p-3 h-32 overflow-y-auto text-xs">
                            <p class="text-gray-600 whitespace-pre-line" x-text="resumePreview"></p>
                            <div x-show="!resumePreview" class="flex items-center justify-center h-full text-gray-400">
                                <span>Preview not available</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step Indicator -->
        <div class="my-8">
            <div class="relative">
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200">
                    <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"
                         :style="`width: ${currentStep * 33.33}%`"></div>
                </div>
                <div class="flex text-xs justify-between">
                    <div class="text-blue-600 font-medium">Job Description</div>
                    <div :class="currentStep >= 2 ? 'text-blue-600 font-medium' : 'text-gray-400'">Optimizing</div>
                    <div :class="currentStep >= 3 ? 'text-blue-600 font-medium' : 'text-gray-400'">Results</div>
                </div>
            </div>
        </div>
        
        <!-- Step 1: Job Description Entry -->
        <div x-show="currentStep === 1" class="fade-in">
            <div class="bg-gradient-to-r from-green-50 to-teal-50 p-8 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Job Description</h2>
                
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <div class="mb-6">
                        <label for="job-title" class="block text-md font-medium text-gray-700 mb-2">
                            Job Title
                        </label>
                        <input 
                            type="text" 
                            id="job-title" 
                            class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                            placeholder="e.g. Senior Software Developer"
                            x-model="jobTitle"
                        >
                    </div>
                    
                    <div>
                        <label for="job-description" class="block text-md font-medium text-gray-700 mb-2">
                            Job Description
                            <span class="text-red-500">*</span>
                        </label>
                        <textarea 
                            id="job-description" 
                            rows="10"
                            class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                            placeholder="Copy and paste the full job description here. The more detailed the description, the better the optimization results."
                            x-model="jobDescription"
                        ></textarea>
                        <p class="mt-1 text-xs text-gray-500">
                            This will be used to tailor your resume specifically for this position.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-between">
                <a href="/dashboard" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Back to Dashboard
                </a>
                <button 
                    type="button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center transition-colors duration-200"
                    :class="{'opacity-50 cursor-not-allowed': !canProceedToOptimization(), 'transform hover:-translate-y-1': canProceedToOptimization()}"
                    :disabled="!canProceedToOptimization()"
                    @click="startOptimization()">
                    <span>Optimize Resume</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Step 2: Optimization In Progress -->
        <div x-show="currentStep === 2" class="fade-in">
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-8 rounded-lg">
                <div class="max-w-2xl mx-auto">
                    <!-- Analysis Header -->
                    <div class="text-center mb-10">
                        <div class="relative">
                            <div class="animate-pulse absolute inset-0 rounded-full bg-blue-200 opacity-50 transform scale-110"></div>
                            <div class="animate-spin relative rounded-full h-20 w-20 border-t-4 border-r-4 border-blue-500 border-opacity-80 mx-auto"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mt-8 mb-2">Optimizing Your Resume</h3>
                        <p class="text-gray-600 max-w-md mx-auto">
                            Our AI is analyzing your resume against the job description to create a perfectly tailored version.
                        </p>
                    </div>
                    
                    <!-- Analysis Progress -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                        <!-- Progress Bar -->
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-100">
                                        Optimization Progress
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-blue-600" x-text="`${optimizationProgress}%`">
                                        0%
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded-full bg-blue-100">
                                <div 
                                    :style="`width: ${optimizationProgress}%`" 
                                    class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-indigo-600 transition-all duration-500 ease-out">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Messages -->
                        <div class="mt-6 space-y-4">
                            <div class="flex items-center" :class="{'text-gray-400': optimizationProgress < 25, 'text-blue-600': optimizationProgress >= 25}">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full border-2 flex items-center justify-center" 
                                     :class="{'border-gray-300': optimizationProgress < 25, 'border-blue-500 bg-blue-50': optimizationProgress >= 25}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" 
                                         :class="{'text-gray-400': optimizationProgress < 25, 'text-blue-600': optimizationProgress >= 25}">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                    </svg>
                                </div>
                                <span class="ml-4 text-sm font-medium">Analyzing resume content</span>
                            </div>
                            
                            <div class="flex items-center" :class="{'text-gray-400': optimizationProgress < 40, 'text-blue-600': optimizationProgress >= 40}">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full border-2 flex items-center justify-center"
                                     :class="{'border-gray-300': optimizationProgress < 40, 'border-blue-500 bg-blue-50': optimizationProgress >= 40}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                         :class="{'text-gray-400': optimizationProgress < 40, 'text-blue-600': optimizationProgress >= 40}">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                    </svg>
                                </div>
                                <span class="ml-4 text-sm font-medium">Analyzing job requirements</span>
                            </div>
                            
                            <div class="flex items-center" :class="{'text-gray-400': optimizationProgress < 65, 'text-blue-600': optimizationProgress >= 65}">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full border-2 flex items-center justify-center"
                                     :class="{'border-gray-300': optimizationProgress < 65, 'border-blue-500 bg-blue-50': optimizationProgress >= 65}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                         :class="{'text-gray-400': optimizationProgress < 65, 'text-blue-600': optimizationProgress >= 65}">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                </div>
                                <span class="ml-4 text-sm font-medium">Enhancing content</span>
                            </div>
                            
                            <div class="flex items-center" :class="{'text-gray-400': optimizationProgress < 85, 'text-blue-600': optimizationProgress >= 85}">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full border-2 flex items-center justify-center"
                                     :class="{'border-gray-300': optimizationProgress < 85, 'border-blue-500 bg-blue-50': optimizationProgress >= 85}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                         :class="{'text-gray-400': optimizationProgress < 85, 'text-blue-600': optimizationProgress >= 85}">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <span class="ml-4 text-sm font-medium">Finalizing your resume</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Activity -->
                    <div class="text-center">
                        <div class="inline-flex items-center px-4 py-2 bg-white border border-blue-100 rounded-full shadow-sm">
                            <div class="animate-pulse w-2 h-2 bg-blue-600 rounded-full mr-3"></div>
                            <p class="text-sm text-gray-700" x-text="optimizationProgressMessage">Initializing...</p>
                        </div>
                        
                        <div class="mt-6 text-xs text-gray-500">
                            <p>This typically takes about 30-60 seconds</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Results with Before/After Comparison -->
        <div x-show="currentStep === 3" class="fade-in">
            <div class="bg-gradient-to-br from-green-50 to-teal-50 p-6 rounded-lg mb-6">
                <div class="text-center mb-5">
                    <svg class="checkmark mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" style="height: 40px; width: 40px;">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                    </svg>
                    <h3 class="text-xl font-bold text-gray-900 mt-3 mb-1">Optimization Complete!</h3>
                    <p class="text-gray-600 text-sm">Your resume has been optimized to maximize ATS compatibility.</p>
                </div>

                <!-- Before and After Score Comparison -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-3">
                        <h4 class="font-medium text-white">ATS Compatibility Score</h4>
                    </div>
                    <div class="p-5">
                        <div class="flex flex-col md:flex-row md:items-center justify-around">
                            <!-- Before Score -->
                            <div class="text-center mb-6 md:mb-0">
                                <h5 class="text-sm font-medium text-gray-500 mb-2">Before Optimization</h5>
                                <div class="relative inline-flex items-center justify-center">
                                    <svg class="w-24 h-24">
                                        <circle
                                            class="text-gray-200"
                                            stroke-width="6"
                                            stroke="currentColor"
                                            fill="transparent"
                                            r="34"
                                            cx="44"
                                            cy="44"
                                        />
                                        <circle
                                            class="text-red-500"
                                            stroke-width="6"
                                            :stroke-dasharray="calculateCircumference(34)"
                                            :stroke-dashoffset="calculateCircumference(34) - (calculateCircumference(34) * optimizationResults.original_ats_score) / 100"
                                            stroke-linecap="round"
                                            stroke="currentColor"
                                            fill="transparent"
                                            r="34"
                                            cx="44"
                                            cy="44"
                                        />
                                    </svg>
                                    <span class="absolute text-xl font-bold" x-text="`${optimizationResults.original_ats_score}%`"></span>
                                </div>
                            </div>
                            
                            <!-- Arrow -->
                            <div class="flex justify-center items-center text-blue-500 mb-4 md:mb-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-8 md:w-8 transform rotate-90 md:rotate-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </div>
                            
                            <!-- After Score -->
                            <div class="text-center">
                                <h5 class="text-sm font-medium text-gray-500 mb-2">After Optimization</h5>
                                <div class="relative inline-flex items-center justify-center">
                                    <svg class="w-24 h-24">
                                        <circle
                                            class="text-gray-200"
                                            stroke-width="6"
                                            stroke="currentColor"
                                            fill="transparent"
                                            r="34"
                                            cx="44"
                                            cy="44"
                                        />
                                        <circle
                                            :class="{
                                                'text-green-500': optimizationResults.optimized_ats_score >= 80,
                                                'text-yellow-500': optimizationResults.optimized_ats_score >= 60 && optimizationResults.optimized_ats_score < 80,
                                                'text-red-500': optimizationResults.optimized_ats_score < 60
                                            }"
                                            stroke-width="6"
                                            :stroke-dasharray="calculateCircumference(34)"
                                            :stroke-dashoffset="calculateCircumference(34) - (calculateCircumference(34) * optimizationResults.optimized_ats_score) / 100"
                                            stroke-linecap="round"
                                            stroke="currentColor"
                                            fill="transparent"
                                            r="34"
                                            cx="44"
                                            cy="44"
                                        />
                                    </svg>
                                    <span class="absolute text-xl font-bold" x-text="`${optimizationResults.optimized_ats_score}%`"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Score Improvement -->
                        <div class="flex justify-center items-center mt-4">
                            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm" :class="{
                                'bg-green-100 text-green-800': optimizationResults.score_improvement > 0,
                                'bg-yellow-100 text-yellow-800': optimizationResults.score_improvement === 0,
                                'bg-red-100 text-red-800': optimizationResults.score_improvement < 0
                            }">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="optimizationResults.score_improvement > 0">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="optimizationResults.score_improvement < 0">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="optimizationResults.score_improvement === 0">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                </svg>
                                <span x-text="optimizationResults.score_improvement > 0 ? `+${optimizationResults.score_improvement}% Improvement` : (optimizationResults.score_improvement === 0 ? 'No Change' : `${optimizationResults.score_improvement}% Decrease`)"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills Analysis -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Matched Skills -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 px-4 py-3">
                            <h4 class="font-medium text-white">Matched Skills</h4>
                        </div>
                        <div class="p-4 h-full">
                            <div class="flex flex-wrap gap-2">
                                <template x-for="skill in optimizationResults.matching_skills" :key="skill">
                                    <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800" x-text="skill"></span>
                                </template>
                            </div>
                            <template x-if="!optimizationResults.matching_skills || optimizationResults.matching_skills.length === 0">
                                <p class="text-sm text-gray-500">No skills directly matched.</p>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Missing Skills -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-4 py-3">
                            <h4 class="font-medium text-white">Skills to Develop</h4>
                        </div>
                        <div class="p-4 h-full">
                            <div class="flex flex-wrap gap-2">
                                <template x-for="skill in optimizationResults.missing_skills" :key="skill">
                                    <span class="px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800" x-text="skill"></span>
                                </template>
                            </div>
                            <template x-if="!optimizationResults.missing_skills || optimizationResults.missing_skills.length === 0">
                                <p class="text-sm text-gray-500">No additional skills recommended.</p>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- AI Recommendation Card -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 mb-6">
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-3">
                        <h4 class="font-medium text-white">AI Recommendation</h4>
                    </div>
                    <div class="p-5">
                        <p class="text-gray-700" x-text="optimizationResults.recommendation || 'No specific recommendations available.'"></p>
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                    <div class="bg-gradient-to-r from-gray-100 to-gray-200 px-4 py-3">
                        <h4 class="font-medium text-gray-700">Actions</h4>
                    </div>
                    <div class="p-4 flex flex-col sm:flex-row justify-center gap-4">
                        <button
                            type="button"
                            class="inline-flex items-center justify-center px-6 py-3 border border-transparent font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
                            @click="downloadOptimizedResume()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Download Optimized Resume
                        </button>
                        <a 
                            href="/dashboard"
                            class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 shadow-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                            </svg>
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Checkmark animation styles */
.checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #7ac142;
    fill: none;
    animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    stroke-width: 3;
    stroke: #7ac142;
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
    100% {
        stroke-dashoffset: 0;
    }
}

/* Fade in animation */
.fade-in {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    function resumeOptimizer() {
        return {
            currentStep: 1,
            resumeId: null,
            resumeDetails: null,
            resumePreview: '',
            jobTitle: '',
            jobDescription: '',
            isOptimizing: false,
            optimizationProgress: 0,
            optimizationProgressMessage: 'Initializing...',
            optimizationResults: {
                original_ats_score: 0,
                optimized_ats_score: 0,
                score_improvement: 0,
                matching_skills: [],
                missing_skills: [],
                recommendation: ''
            },
            progressInterval: null,
            
            init(resumeId) {
                // Initialize the component with the resume ID
                this.resumeId = resumeId;
                
                // Fetch resume details
                this.fetchResumeDetails();
                
                // Clean up on navigation
                window.addEventListener('beforeunload', () => {
                    if (this.progressInterval) {
                        clearInterval(this.progressInterval);
                    }
                });
            },
            
            // Fetch resume details from the API
            async fetchResumeDetails() {
                try {
                    const response = await fetch(`/api/resume/${this.resumeId}`);
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch resume details');
                    }
                    
                    const data = await response.json();
                    this.resumeDetails = data;
                    
                    // Only show a preview of the resume content (first 200 chars)
                    if (data.original_content) {
                        this.resumePreview = data.original_content.substring(0, 200) + '...';
                    }
                    
                    // If job description was already present, pre-fill it
                    if (data.job_description) {
                        this.jobDescription = data.job_description;
                    }
                    
                } catch (error) {
                    console.error('Error fetching resume details:', error);
                    alert('Failed to load resume details. Please try again.');
                }
            },
            
            // Check if we can proceed to optimization
            canProceedToOptimization() {
                return this.jobDescription.trim().length > 0 && !this.isOptimizing;
            },
            
            // Start the optimization process
            async startOptimization() {
                if (!this.canProceedToOptimization()) return;
                
                this.currentStep = 2;
                this.isOptimizing = true;
                
                // Start progress animation
                this.startProgressSimulation();
                
                // Send the job description for optimization
                try {
                    const response = await fetch(`/api/resume/${this.resumeId}/optimize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            job_description: this.jobDescription,
                            job_title: this.jobTitle || undefined
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to optimize resume');
                    }
                    
                    const data = await response.json();
                    
                    // Store optimization results
                    this.optimizationResults = {
                        original_ats_score: data.original_ats_score || 0,
                        optimized_ats_score: data.optimized_ats_score || 0,
                        score_improvement: data.score_improvement || 0,
                        matching_skills: data.matching_skills || [],
                        missing_skills: data.missing_skills || [],
                        recommendation: data.recommendation || ''
                    };
                    
                    // Complete the progress simulation
                    clearInterval(this.progressInterval);
                    this.optimizationProgress = 100;
                    this.optimizationProgressMessage = 'Optimization complete!';
                    
                    // Move to results step after a short delay
                    setTimeout(() => {
                        this.currentStep = 3;
                        this.isOptimizing = false;
                    }, 500);
                    
                } catch (error) {
                    console.error('Error optimizing resume:', error);
                    alert('Failed to optimize resume. Please try again.');
                    this.currentStep = 1;
                    this.isOptimizing = false;
                    clearInterval(this.progressInterval);
                }
            },
            
            // Simulate progress animation during optimization
            startProgressSimulation() {
                this.optimizationProgress = 0;
                this.optimizationProgressMessage = 'Analyzing resume content...';
                
                this.progressInterval = setInterval(() => {
                    if (this.optimizationProgress < 95) {
                        this.optimizationProgress += Math.floor(Math.random() * 15);
                        if (this.optimizationProgress > 95) this.optimizationProgress = 95;
                        
                        // Update progress message based on progress
                        if (this.optimizationProgress < 30) {
                            this.optimizationProgressMessage = 'Analyzing key skills...';
                        } else if (this.optimizationProgress < 60) {
                            this.optimizationProgressMessage = 'Analyzing job requirements...';
                        } else if (this.optimizationProgress < 80) {
                            this.optimizationProgressMessage = 'Enhancing content...';
                        } else {
                            this.optimizationProgressMessage = 'Finalizing your optimized resume...';
                        }
                    }
                }, 1000);
            },
            
            // Download the optimized resume as PDF
            async downloadOptimizedResume() {
                if (!this.resumeId) return;
                
                try {
                    // Open the download URL in a new tab
                    window.open(`/api/resume/${this.resumeId}/download?use_optimized=true`, '_blank');
                } catch (error) {
                    console.error('Error downloading resume:', error);
                    alert('Failed to download resume. Please try again.');
                }
            },
            
            // Format date for display
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            },
            
            // Calculate circumference for SVG circle animation
            calculateCircumference(radius) {
                return 2 * Math.PI * radius;
            }
        }
    }
</script>
{% endblock %}